const { Pool } = require('pg');
const fs = require('fs');
const path = require('path');

const migrateDatabase = async () => {
  try {
    console.log('🚀 Starting production database migration...');
    console.log('📊 Connecting to database...');
    
    const pool = new Pool({
      connectionString: process.env.DATABASE_URL,
      ssl: { rejectUnauthorized: false }
    });
    
    // Test connection
    await pool.query('SELECT NOW()');
    console.log('✅ Database connection successful');
    
    // Read and execute schema
    const schemaPath = path.join(__dirname, '../config/schema.sql');
    const schemaSQL = fs.readFileSync(schemaPath, 'utf8');
    
    await pool.query(schemaSQL);
    console.log('✅ Database schema created successfully');
    
    // Create a test user (optional)
    const testUserQuery = `
      INSERT INTO users (username, email, password_hash) 
      VALUES ('demo', 'demo@ande.app', '$2a$12$dummy.hash.for.demo.user.only')
      ON CONFLICT (email) DO NOTHING
      RETURNING id;
    `;
    
    const result = await pool.query(testUserQuery);
    if (result.rows.length > 0) {
      console.log('✅ Demo user created');
    } else {
      console.log('ℹ️  Demo user already exists');
    }
    
    await pool.end();
    console.log('🎉 Database migration completed successfully!');
    
  } catch (error) {
    console.error('❌ Database migration failed:', error);
    throw error;
  }
};

// Run migration if called directly
if (require.main === module) {
  migrateDatabase()
    .then(() => process.exit(0))
    .catch(() => process.exit(1));
}

module.exports = migrateDatabase;